<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>07-综合案例-状态保持 | 酱紫的世界</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="icon" href="/blog/assets/img/logo.png">
    <meta name="description" content="true">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/blog/assets/css/0.styles.392da318.css" as="style"><link rel="preload" href="/blog/assets/js/app.58f092a7.js" as="script"><link rel="preload" href="/blog/assets/js/3.02682d00.js" as="script"><link rel="preload" href="/blog/assets/js/1.871cdb80.js" as="script"><link rel="preload" href="/blog/assets/js/40.4c395ce2.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.4b8e68b5.js"><link rel="prefetch" href="/blog/assets/js/11.48f7e7b3.js"><link rel="prefetch" href="/blog/assets/js/12.cb6a7e89.js"><link rel="prefetch" href="/blog/assets/js/13.96f88831.js"><link rel="prefetch" href="/blog/assets/js/14.33e9c708.js"><link rel="prefetch" href="/blog/assets/js/15.f71d14ef.js"><link rel="prefetch" href="/blog/assets/js/16.e8a23a24.js"><link rel="prefetch" href="/blog/assets/js/17.ec4182e0.js"><link rel="prefetch" href="/blog/assets/js/18.87bfcf36.js"><link rel="prefetch" href="/blog/assets/js/19.bb93a79a.js"><link rel="prefetch" href="/blog/assets/js/20.e193383f.js"><link rel="prefetch" href="/blog/assets/js/21.3acce85e.js"><link rel="prefetch" href="/blog/assets/js/22.9592fc37.js"><link rel="prefetch" href="/blog/assets/js/23.b5d154b3.js"><link rel="prefetch" href="/blog/assets/js/24.779b354d.js"><link rel="prefetch" href="/blog/assets/js/25.bbd8f75f.js"><link rel="prefetch" href="/blog/assets/js/26.ae3851d7.js"><link rel="prefetch" href="/blog/assets/js/27.9f0f8937.js"><link rel="prefetch" href="/blog/assets/js/28.dbdadcdc.js"><link rel="prefetch" href="/blog/assets/js/29.f8c02d18.js"><link rel="prefetch" href="/blog/assets/js/30.ccc098b8.js"><link rel="prefetch" href="/blog/assets/js/31.3147958d.js"><link rel="prefetch" href="/blog/assets/js/32.d46ffbdf.js"><link rel="prefetch" href="/blog/assets/js/33.f006d21e.js"><link rel="prefetch" href="/blog/assets/js/34.4264c1f8.js"><link rel="prefetch" href="/blog/assets/js/35.6489a096.js"><link rel="prefetch" href="/blog/assets/js/36.125aeda3.js"><link rel="prefetch" href="/blog/assets/js/37.fd5b48f1.js"><link rel="prefetch" href="/blog/assets/js/38.77c379b3.js"><link rel="prefetch" href="/blog/assets/js/39.f1321abd.js"><link rel="prefetch" href="/blog/assets/js/4.71085767.js"><link rel="prefetch" href="/blog/assets/js/41.a0e7814d.js"><link rel="prefetch" href="/blog/assets/js/42.e2ac21eb.js"><link rel="prefetch" href="/blog/assets/js/43.995e61c4.js"><link rel="prefetch" href="/blog/assets/js/44.9bc96476.js"><link rel="prefetch" href="/blog/assets/js/45.946ed06e.js"><link rel="prefetch" href="/blog/assets/js/46.b4389247.js"><link rel="prefetch" href="/blog/assets/js/47.77adb3ca.js"><link rel="prefetch" href="/blog/assets/js/48.c5563424.js"><link rel="prefetch" href="/blog/assets/js/49.72c58993.js"><link rel="prefetch" href="/blog/assets/js/5.ac4aaf88.js"><link rel="prefetch" href="/blog/assets/js/50.697f0bdc.js"><link rel="prefetch" href="/blog/assets/js/51.bc5236ff.js"><link rel="prefetch" href="/blog/assets/js/52.5ac0901a.js"><link rel="prefetch" href="/blog/assets/js/53.81e722f4.js"><link rel="prefetch" href="/blog/assets/js/54.1b53144a.js"><link rel="prefetch" href="/blog/assets/js/55.2bbbcf18.js"><link rel="prefetch" href="/blog/assets/js/56.60db07b5.js"><link rel="prefetch" href="/blog/assets/js/57.1b96081c.js"><link rel="prefetch" href="/blog/assets/js/58.a4bf3f83.js"><link rel="prefetch" href="/blog/assets/js/59.a3b13bc5.js"><link rel="prefetch" href="/blog/assets/js/6.8b81569d.js"><link rel="prefetch" href="/blog/assets/js/60.38c55e9a.js"><link rel="prefetch" href="/blog/assets/js/61.ef631447.js"><link rel="prefetch" href="/blog/assets/js/62.248cc615.js"><link rel="prefetch" href="/blog/assets/js/63.d5ee692d.js"><link rel="prefetch" href="/blog/assets/js/64.86cb0325.js"><link rel="prefetch" href="/blog/assets/js/65.613a209b.js"><link rel="prefetch" href="/blog/assets/js/66.fd2e8c40.js"><link rel="prefetch" href="/blog/assets/js/67.9bb3328f.js"><link rel="prefetch" href="/blog/assets/js/68.a9aa9589.js"><link rel="prefetch" href="/blog/assets/js/69.8d58cc91.js"><link rel="prefetch" href="/blog/assets/js/7.eb7aa0b9.js"><link rel="prefetch" href="/blog/assets/js/70.5294a42f.js"><link rel="prefetch" href="/blog/assets/js/71.8b600400.js"><link rel="prefetch" href="/blog/assets/js/72.a8d5d3d6.js"><link rel="prefetch" href="/blog/assets/js/8.51846351.js"><link rel="prefetch" href="/blog/assets/js/9.cfaa1aff.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.392da318.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>酱紫的世界</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>酱紫</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/img/logo.png" alt="酱紫的世界" class="logo"> <span class="site-name">酱紫的世界</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/ajax/" class="nav-link"><i class="iconfont undefined"></i>
  ajax
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/canvas/" class="nav-link"><i class="iconfont undefined"></i>
  canvas
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/css3/" class="nav-link"><i class="iconfont undefined"></i>
  css3
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/es6/" class="nav-link"><i class="iconfont undefined"></i>
  es6
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/html/" class="nav-link"><i class="iconfont undefined"></i>
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/jquery/" class="nav-link"><i class="iconfont undefined"></i>
  jquery
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/js基础/" class="nav-link"><i class="iconfont undefined"></i>
  js基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/js高级/" class="nav-link"><i class="iconfont undefined"></i>
  js高级
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/移动web/" class="nav-link"><i class="iconfont undefined"></i>
  移动web
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nodejs/" class="nav-link"><i class="iconfont undefined"></i>
  nodejs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ps/" class="nav-link"><i class="iconfont undefined"></i>
  ps
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/工具/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/正则/" class="nav-link"><i class="iconfont undefined"></i>
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/webapi/" class="nav-link"><i class="iconfont undefined"></i>
  webapi
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/blog/study/" class="nav-link"><i class="iconfont reco-linkedin"></i>
  学习
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/tools/浏览器同步测试工具/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器同步测试工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/regexp/正则表达式/" class="nav-link"><i class="iconfont undefined"></i>
  正则表达式
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-b038cec6><img src="/blog/assets/img/logo.png" alt="author-avatar" class="personal-img" data-v-b038cec6> <h3 class="name" data-v-b038cec6>
    酱紫
  </h3> <div class="num" data-v-b038cec6><div data-v-b038cec6><h3 data-v-b038cec6>56</h3> <h6 data-v-b038cec6>Article</h6></div> <div data-v-b038cec6><h3 data-v-b038cec6>14</h3> <h6 data-v-b038cec6>Tag</h6></div></div> <hr data-v-b038cec6></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/ajax/" class="nav-link"><i class="iconfont undefined"></i>
  ajax
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/canvas/" class="nav-link"><i class="iconfont undefined"></i>
  canvas
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/css3/" class="nav-link"><i class="iconfont undefined"></i>
  css3
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/es6/" class="nav-link"><i class="iconfont undefined"></i>
  es6
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/html/" class="nav-link"><i class="iconfont undefined"></i>
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/jquery/" class="nav-link"><i class="iconfont undefined"></i>
  jquery
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/js基础/" class="nav-link"><i class="iconfont undefined"></i>
  js基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/js高级/" class="nav-link"><i class="iconfont undefined"></i>
  js高级
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/移动web/" class="nav-link"><i class="iconfont undefined"></i>
  移动web
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nodejs/" class="nav-link"><i class="iconfont undefined"></i>
  nodejs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ps/" class="nav-link"><i class="iconfont undefined"></i>
  ps
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/工具/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/正则/" class="nav-link"><i class="iconfont undefined"></i>
  正则
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/webapi/" class="nav-link"><i class="iconfont undefined"></i>
  webapi
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/blog/study/" class="nav-link"><i class="iconfont reco-linkedin"></i>
  学习
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/tools/浏览器同步测试工具/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器同步测试工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/regexp/正则表达式/" class="nav-link"><i class="iconfont undefined"></i>
  正则表达式
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/nodejs/01-Web概念-初识Node.js.html" class="sidebar-link">01-Web概念-初识Node.js</a></li><li><a href="/blog/nodejs/02-文件模块-核心模块-第三方模块.html" class="sidebar-link">02-文件模块-核心模块-第三方模块</a></li><li><a href="/blog/nodejs/03-HTTP协议-静态服务器.html" class="sidebar-link">03-HTTP协议-静态服务器</a></li><li><a href="/blog/nodejs/04-动态服务器.html" class="sidebar-link">04-动态服务器</a></li><li><a href="/blog/nodejs/05-Express.html" class="sidebar-link">05-Express</a></li><li><a href="/blog/nodejs/06-MySQL.html" class="sidebar-link">06-MySQL</a></li><li><a href="/blog/nodejs/07-综合案例-状态保持.html" class="active sidebar-link">07-综合案例-状态保持</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#综合案例" class="sidebar-link">综合案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#搭建项目" class="sidebar-link">搭建项目</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#入口文件" class="sidebar-link">入口文件</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#配置路由" class="sidebar-link">配置路由</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#模板继承" class="sidebar-link">模板继承</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#功能实现" class="sidebar-link">功能实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#中间件-middleware-express" class="sidebar-link">中间件(middleware) express</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#什么是中间件" class="sidebar-link">什么是中间件</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#中间件分类" class="sidebar-link">中间件分类</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#会话保持" class="sidebar-link">会话保持</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#cookie" class="sidebar-link">Cookie</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#cookie-与-http-协议" class="sidebar-link">Cookie 与 HTTP 协议</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#在浏览器中操作-cookie" class="sidebar-link">在浏览器中操作 Cookie</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#session" class="sidebar-link">Session</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#cookie-和-session-的区别" class="sidebar-link">Cookie 和 Session 的区别</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs/07-综合案例-状态保持.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>07-综合案例-状态保持</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>酱紫</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>07-综合案例-状态保持</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>酱紫</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-06-15</span></i> <i class="iconfont reco-eye" data-v-484a899e><span id="/blog/nodejs/07-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B-%E7%8A%B6%E6%80%81%E4%BF%9D%E6%8C%81.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-484a899e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      nodejs
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="服务端编程node-js"><a href="#服务端编程node-js" class="header-anchor">#</a> 服务端编程Node.js</h1> <h2 id="综合案例"><a href="#综合案例" class="header-anchor">#</a> 综合案例</h2> <p>实现对留言的数据管理--增删改查</p> <h3 id="搭建项目"><a href="#搭建项目" class="header-anchor">#</a> 搭建项目</h3> <ul><li><p>初始化 package.json</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 新建项目文件夹，guestbook</span>
<span class="token function">npm</span> init -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>安装使用到的第三方包</p> <ul><li>express</li> <li>body-parser</li> <li>mysql</li> <li>art-template</li> <li>express-art-template</li></ul></li> <li><p>项目结构</p> <p>设置静态资源，设置静态模板</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
├── package.json			
├── routes					存储路由模块
├── statics					存储静态资源
│   ├── css
│   ├── fonts
│   ├── images
│   └── js
├── views						存储模板
│   ├── admin
│   └── login.html
├── app.js					程序的入口文件
└── db.js						操作数据库的模块
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li></ul> <h3 id="入口文件"><a href="#入口文件" class="header-anchor">#</a> 入口文件</h3> <ul><li><p>导入第三方模块</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const bodyParser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const expressTPL <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express-art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>配置第三方模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 1. 配置静态资源</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'statics'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'statics'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. 配置body-parser 解析请求体</span>
<span class="token comment">// parse application/x-www-form-urlencoded</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3. 配置 express 模板引擎</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span> expressTPL<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul> <h3 id="配置路由"><a href="#配置路由" class="header-anchor">#</a> 配置路由</h3> <table><thead><tr><th>请求方法</th> <th>路径</th> <th>功能</th></tr></thead> <tbody><tr><td>get</td> <td>/admin</td> <td>后台首页-留言列表</td></tr> <tr><td>get</td> <td>/admin/add</td> <td>返回添加页面</td></tr> <tr><td>get</td> <td>/admin/edit</td> <td>返回编辑页面</td></tr> <tr><td>get</td> <td>/login</td> <td>返回登录页面</td></tr> <tr><td>get</td> <td>/</td> <td>返回前台首页</td></tr> <tr><td>get</td> <td>/admin/delete</td> <td>实现删除功能，需要参数id</td></tr> <tr><td>post</td> <td>/admin/add</td> <td>实现添加功能</td></tr> <tr><td>post</td> <td>/admin/edit</td> <td>实现编辑功能</td></tr> <tr><td>post</td> <td>/login</td> <td>实现登录功能</td></tr> <tr><td>get</td> <td>/logout</td> <td>实现退出功能</td></tr></tbody></table> <ul><li><p>路由地址非常多，所以要放到不同的模块中处理(routes)。</p></li> <li><p>可以把路由分为三类：后台管理、登录相关、前台功能。</p></li> <li><p>routes <strong>文件夹中创建三个模块</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>└── routes
    ├── messages.js    后台数据管理的路由
    ├── users.js			 登录退出的路由
    └── index.js			 前台功能的路由
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>实现页面的展示功能，<code>js routes/messgaes.js</code> 中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 其它省略</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>注册路由模块，<code>js app.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> msgRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/messages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> msgRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>静态资源路径的问题</p> <ul><li>访问 http://127.0.0.1:3000/admin    --- index.html(静态资源相对路径)  css/main.css
<ul><li>此时静态资源  http://127.0.0.1:3000/css/main.css</li></ul></li> <li>访问 http://127.0.0.1:3000/admin/   --- index.html(静态资源相对路径)  css/main.css
<ul><li>此时静态资源 http://127.0.0.1:3000/admin/css/main.css</li></ul></li> <li>解决问题：
<ul><li>在 index.html 中设置静态资源的路径，根路径  /css/main.css</li> <li>根路径： http://127.0.0.1:3000</li></ul></li> <li>路径
<ul><li>文件系统中的路径：建议使用绝对路径</li> <li>URL 路径：网页中连接外部文件建议使用 根路径 (/)</li></ul></li></ul></li></ul> <h3 id="模板继承"><a href="#模板继承" class="header-anchor">#</a> 模板继承</h3> <ul><li>后台列表页面、添加页面、编辑页面中大部分内容都是相同的</li> <li>可以把相同的部分提取到一个 <code>layout.html</code>  文件中，让所有子页面继承 <code>layout.html</code></li> <li><strong>让页面中重复的内容不再重复</strong></li></ul> <h4 id="提取-layout-html"><a href="#提取-layout-html" class="header-anchor">#</a> 提取 <code>layout.html</code></h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>├── views						存储模板
    ├── admin
    │		├── _layout					约定的文件夹名字，存储父模板
    │   │   └── layout.html
    │   ├── index.html
    │   ├── add.html
    │   ├── edit.html
    └── login.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="layout-html-中挖坑"><a href="#layout-html-中挖坑" class="header-anchor">#</a> layout.html 中挖坑</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>page-header<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ block 'title' }}{{ /block }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

{{ block 'content' }}{{ /block }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="其它页面中填坑"><a href="#其它页面中填坑" class="header-anchor">#</a> 其它页面中填坑</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 导入父模板 --&gt;</span>
{{ extend './_layout/layout.html' }}
<span class="token comment">&lt;!-- 填充父模板 title 的位置 --&gt;</span>
{{ block 'title' }}
留言管理
{{ /block }}
<span class="token comment">&lt;!-- 填充父模板 content 的位置 --&gt;</span>
{{ block 'content' }}
.....填充的内容
{{ /block }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="功能实现"><a href="#功能实现" class="header-anchor">#</a> 功能实现</h3> <h4 id="准备-db-js-数据库操作模块"><a href="#准备-db-js-数据库操作模块" class="header-anchor">#</a> 准备 <code>db.js</code> 数据库操作模块</h4> <h4 id="后台管理-留言列表"><a href="#后台管理-留言列表" class="header-anchor">#</a> 后台管理-留言列表</h4> <ul><li><p>准备工作，引入 <code>db.js</code> 模块</p></li> <li><p>注册路由， <code>routes/messages.js</code> 模块中</p></li> <li><p>操作数据库，查询所有留言</p></li> <li><p>渲染模板</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// routes/messages.js</span>
<span class="token comment">// 注册路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 查询所有留言</span>
  db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from messages'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token comment">// 渲染模板，传入数据</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      msgs<span class="token operator">:</span> results
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>设置模板，<code>views/admin/index.html</code> 中</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>{{ each msgs }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{{ $index + 1 }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{{ $value.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ $value.img }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
    {{ $value.time | dateFormat 'YYYY-MM-DD HH:mm:ss' }}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/edit?id={{ $value.id }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-xs btn-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更新<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/delete?id={{ $value.id }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>return confirm('确山删除？')<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-xs btn-danger<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
{{ /each }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>细节处理-日期格式的展示</p> <ul><li><p>moment.js</p></li> <li><p>使用模板引擎 art-template 中的<strong>过滤器</strong></p> <p><strong>过滤器的作用</strong>：对模板中的数据进行格式化</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// routes/messages.js</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 给 art-template 设置过滤器</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>imports<span class="token punctuation">.</span><span class="token function-variable function">dateFormat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">date<span class="token punctuation">,</span> format</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在模板中调用 {{ $value.time | dateFormat 'YYYY-MM-DD HH:mm:ss' }}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul></li></ul> <h4 id="后台管理-删除留言"><a href="#后台管理-删除留言" class="header-anchor">#</a> 后台管理-删除留言</h4> <ul><li><p>在模板中设置删除按钮的地址，设置查询字符串</p> <ul><li><p>通过 url 传递，留言信息的唯一标示 <code>id</code></p></li> <li><p>点击删除按钮提示是否删除</p></li> <li><p><code>views/admin/index.html</code>中</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 通过 url 传递id --&gt;</span>
<span class="token comment">&lt;!-- 点击删除按钮，提示是否删除 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/admin/delete?id={{ $value.id }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>return confirm('确山删除？')<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-xs btn-danger<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p>注册路由，在 <code>routes/messages.js</code> 模块中</p></li> <li><p>获取 <code>url</code> 中的查询字符串，参数 <code>id</code></p> <ul><li>req.query</li></ul></li> <li><p>数据库操作 - 删除</p></li> <li><p>删除成功后，提示并跳转</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// routes/messages.js</span>
<span class="token comment">// 删除数据</span>
<span class="token comment">// 注册路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/delete'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取查询字符串参数 id</span>
  <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token comment">// TODO 判断id是否为数字</span>
  <span class="token comment">// 执行数据库操作 - 删除</span>
  db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'delete from messages where id=?'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token comment">// 判断成功还是失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;删除成功&quot;);location.href=&quot;/admin&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;删除失败&quot;);location.href=&quot;/admin&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li></ul> <h4 id="后台管理-添加留言"><a href="#后台管理-添加留言" class="header-anchor">#</a> 后台管理-添加留言</h4> <ul><li><p>设置 <code>views/admin/add</code> 模板中的表单</p> <ul><li>method ： post</li> <li>action：/admin/add</li> <li>检查表单元素，name属性，建议和字段的名字一样</li></ul></li> <li><p>注册路由，<code>routes/messages.js</code> 模块中</p></li> <li><p>构建消息对象（接收post的请求体）</p></li> <li><p>执行数据库操作--添加</p></li> <li><p>判断添加是否成功</p></li> <li><p>提示并跳转</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// routes/messages.js</span>
<span class="token comment">// 添加留言</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构造对象，添加到数据库</span>
  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    content<span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
    <span class="token comment">// time 数据库自动生成</span>
    img<span class="token operator">:</span> <span class="token string">'images/timg.jpg'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'insert into messages set ?'</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;添加成功&quot;);location.href=&quot;/&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;添加成功&quot;);location.href=&quot;/add&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ul> <h4 id="后台管理-编辑留言"><a href="#后台管理-编辑留言" class="header-anchor">#</a> 后台管理-编辑留言</h4> <h5 id="显示编辑信息"><a href="#显示编辑信息" class="header-anchor">#</a> 显示编辑信息</h5> <ul><li><p>点击编辑按钮，跳转到编辑页面，展示要编辑的信息</p> <ul><li><p>通过 url 传递，留言信息的唯一标示 <code>id</code></p></li> <li><p><code>views/admin/index.html</code>中</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/admin/edit?id={{ $value.id }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-xs btn-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更新<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>修改编辑的模板，展示编辑信息 <code>views/admin/edit.html</code> 中</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 文本框中绑定信息 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-control<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>用户名<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ msg.name }}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 省略其它 --&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p>在服务器上获取信息，渲染模板</p> <ul><li><p><code>routes/messages.js</code> 模块中</p></li> <li><p>注册路由</p></li> <li><p>接收通过查询字符串传递的 <code>id</code></p></li> <li><p>数据库操作--根据 <code>id</code> 查询留言信息</p></li> <li><p>判断是否查询到结果</p></li> <li><p>渲染模板</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// routes/messages.js</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/edit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token comment">// TODO 判断id是否是数字</span>
  db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from messages where id=?'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/edit'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        msg<span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;没有获取到数据&quot;);location.href=&quot;/admin&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li></ul></li></ul> <h5 id="实现编辑功能"><a href="#实现编辑功能" class="header-anchor">#</a> 实现编辑功能</h5> <ul><li><p>检查 <code>views/admin/edit.html</code> 表单</p> <ul><li><p>method  提交的方法 post</p></li> <li><p>action 提交的路径，<code>/admin/edit?id=msg.id</code>  (msg.id 用双大括号包裹起来 )</p></li> <li><p>检查表单元素，具有name属性，希望name属性的值，跟数据库字段的值一致</p></li> <li><p>提交按钮  是否是提交按钮</p></li></ul></li> <li><p><code>routes/messages.js</code> 模块中</p></li></ul> <img src="/blog/assets/img/msdid.3b0f25d3.png" width="500"> <ul><li><p>注册路由</p></li> <li><p>接收通过查询字符串传递的 <code>id</code></p></li> <li><p>接收 post 过来的请求体</p></li> <li><p>构造 sql 语句，和对应的参数</p></li> <li><p>数据库操作--更新留言</p></li> <li><p>判断是否操作是否成功</p></li> <li><p>提示并跳转</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// routes/messages.js</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/edit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token string">'update messages set name=?, content=?, time=?, img=? where id=?'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>content<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>time<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>img<span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script&gt;alert(&quot;修改成功&quot;); location.href=&quot;/&quot;;&lt;/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;alert(&quot;修改失败&quot;); location.href=&quot;/edit?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ul> <h2 id="中间件-middleware-express"><a href="#中间件-middleware-express" class="header-anchor">#</a> 中间件(middleware) express</h2> <p>为了理解中间件，我们先来看一下我们现实生活中的自来水厂的净水流程。</p> <p><img src="assets/water-middleware.jpeg" alt="中间件"></p> <ul><li>在上图中，自来水厂从获取水源到净化处理交给用户，中间经历了一系列的处理环节</li> <li>我们称其中的每一个处理环节就是一个中间件。</li> <li>这样做的目的既提高了生产效率也保证了可维护性。</li></ul> <h3 id="什么是中间件"><a href="#什么是中间件" class="header-anchor">#</a> 什么是中间件</h3> <ul><li>中间件是 Express 的最大特色，也是最重要的一个设计</li> <li>一个 Express 应用，就是由许许多多的中间件来完成的</li> <li>中间件函数是能够访问请求对象、响应对象，以及应用程序的请求/响应循环中的下一个中间件函数</li> <li>中间件函数可以执行以下任何任务
<ul><li>执行任何代码</li> <li>修改 request 或者 response 响应对象</li> <li>结束请求响应周期</li> <li>调用下一个中间件</li></ul></li></ul> <h3 id="中间件分类"><a href="#中间件分类" class="header-anchor">#</a> 中间件分类</h3> <ul><li><p>内置中间件</p> <ul><li>express.static()</li></ul></li> <li><p>第三方中间件</p> <ul><li>body-parser</li></ul></li> <li><p>应用程序级别中间件</p> <ul><li><p>所有请求中打印日志</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 在注册路由之前</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'打印日志'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入下一个路由处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>处理 404</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 在注册路由之后</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'这是一个漂亮的404页面'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul></li> <li><p>路由级别中间件</p></li> <li><p>错误处理中间件</p> <ul><li><p>全局处理错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 在注册路由之后</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Something broke!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul></li></ul> <h2 id="会话保持"><a href="#会话保持" class="header-anchor">#</a> 会话保持</h2> <p>HTTP 协议是无状态的，服务端不能跟踪客户端的状态，也就无法记录客户端登录的状态。</p> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h3> <h4 id="什么是-cookie"><a href="#什么是-cookie" class="header-anchor">#</a> 什么是 Cookie</h4> <ul><li>Cookie - 小甜点，属于 HTTP 协议的一部分</li> <li><strong>是服务器发送到用户浏览器并保存在本地的一小块数据</strong></li> <li><strong>在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上</strong></li> <li>它用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态</li> <li>Cookie 使基于<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview#HTTP_is_stateless_but_not_sessionless" target="_blank" rel="noopener noreferrer">无状态<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 HTTP 协议记录稳定的状态信息成为了可能</li> <li>Cookie 存储的数据量有限，由浏览器决定，一般在4KB左右</li></ul> <h4 id="cookie-的使用场景"><a href="#cookie-的使用场景" class="header-anchor">#</a> Cookie 的使用场景</h4> <p>Cookie 主要用来分辨两个请求是否来自同一个浏览器，以及用来保存一些状态信息。它的常用场合有以下一些。</p> <ul><li>对话（session）管理：保存登录、购物车等需要记录的信息。</li> <li>个性化：保存用户的偏好，比如网页的字体大小、背景色等等。</li> <li>追踪：记录和分析用户行为。</li></ul> <h4 id="操作-cookie"><a href="#操作-cookie" class="header-anchor">#</a> 操作 Cookie</h4> <p>Cookie 是由键值对组成的。</p> <h5 id="服务端设置-cookie"><a href="#服务端设置-cookie" class="header-anchor">#</a> 服务端设置 Cookie</h5> <p>设置 Cookie 不需要第三方模块。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// express 给 res 对象增加了 cookie 方法</span>
res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="服务端获取-cookie"><a href="#服务端获取-cookie" class="header-anchor">#</a> 服务端获取 Cookie</h5> <ul><li><p>直接获取，需要自己解析</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 直接从请求头获取  name=zs; xx=123 需要自己解析字符串</span>
req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>使用第三方模块</p> <ul><li><p>安装 <a href="https://github.com/expressjs/cookie-parser" target="_blank" rel="noopener noreferrer">cookie-parser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>配置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>req<span class="token punctuation">.</span>cookies
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li></ul> <h4 id="cookie-的属性"><a href="#cookie-的属性" class="header-anchor">#</a> Cookie 的属性</h4> <p>Cookie 的访问被限制，只能在<strong>当前域名</strong>下可以访问。(不能跨域访问)。</p> <ul><li><p>Path</p> <p><code>Path</code>属性指定浏览器发出 HTTP 请求时，哪些路径要附带这个 Cookie。只要浏览器发现，<code>Path</code>属性是 HTTP 请求路径的开头一部分，就会在头信息里面带上这个 Cookie。比如，<code>PATH</code>属性是<code>/</code>，那么请求<code>/docs</code>路径也会包含该 Cookie。当然，前提是域名必须一致。</p></li> <li><p><strong>HttpOnly</strong></p> <p>设置该属性的话，不允许客户端操作 Cookie</p></li> <li><p>Expires</p> <p>设置过期时间，具体的时间点</p></li> <li><p>Max-Age</p> <p>设置过期时间，时间段，隔多长时间过期，单位是秒 (例如：60*60  1小时)</p> <p>如果同时设置 Max-Age 和 Expires，Max-Age优先</p> <p><strong>如果没有设置 Expires 和 Max-Age，浏览器关闭 Cookie 就消失 (只存储在内存中)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'zs'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  <span class="token comment">// 此处的单位是 毫秒</span>
  maxAge<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h3 id="cookie-与-http-协议"><a href="#cookie-与-http-协议" class="header-anchor">#</a> Cookie 与 HTTP 协议</h3> <p>Cookie 由 HTTP 协议生成，也主要是供 HTTP 协议使用。</p> <h4 id="http-响应：cookie-的生成"><a href="#http-响应：cookie-的生成" class="header-anchor">#</a> HTTP 响应：Cookie 的生成</h4> <p>服务器如果希望在浏览器保存 Cookie，就要在 HTTP 回应的头信息里面，放置一个<code>Set-Cookie</code>字段。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Set-Cookie:foo=bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面代码会在浏览器保存一个名为<code>foo</code>的 Cookie，它的值为<code>bar</code>。</p> <p>HTTP 回应可以包含多个<code>Set-Cookie</code>字段，即在浏览器生成多个 Cookie。下面是一个例子。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>HTTP/1.0 200 OK
Content-type: text/html
Set-Cookie: yummy_cookie=choco; HttpOnly
Set-Cookie: tasty_cookie=strawberry; HttpOnly
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>下面是一个例子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Set<span class="token operator">-</span>Cookie<span class="token operator">:</span> id<span class="token operator">=</span>a3fWa<span class="token punctuation">;</span> Expires<span class="token operator">=</span>Wed<span class="token punctuation">,</span> <span class="token number">21</span> Oct <span class="token number">2015</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">GMT</span><span class="token punctuation">;</span> Secure<span class="token punctuation">;</span> HttpOnly
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="http-请求：cookie-的发送"><a href="#http-请求：cookie-的发送" class="header-anchor">#</a> HTTP 请求：Cookie 的发送</h4> <p>浏览器向服务器发送 HTTP 请求时，每个请求都会带上相应的 Cookie。也就是说，把服务器早前保存在浏览器的这段信息，再发回服务器。这时要使用 HTTP 头信息的<code>Cookie</code>字段。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Cookie: foo=bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面代码会向服务器发送名为<code>foo</code>的 Cookie，值为<code>bar</code>。</p> <p><code>Cookie</code>字段可以包含多个 Cookie，使用分号（<code>;</code>）分隔。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Cookie: name=value; name2=value2; name3=value3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面是一个例子。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /sample_page.html HTTP/1.1
Host: www.example.org
Cookie: yummy_cookie=choco; tasty_cookie=strawberry
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="在浏览器中操作-cookie"><a href="#在浏览器中操作-cookie" class="header-anchor">#</a> 在浏览器中操作 Cookie</h3> <h4 id="document-cookie"><a href="#document-cookie" class="header-anchor">#</a> document.cookie</h4> <p><code>document.cookie</code>属性用于读写当前网页的 Cookie。</p> <p>读取的时候，它会返回当前网页的所有 Cookie，前提是该 Cookie 不能有<code>HTTPOnly</code>属性。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>document.cookie // &quot;foo=bar;baz=bar&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>document.cookie</code>属性是可写的，可以通过它为当前网站添加 Cookie。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>document.cookie = 'fontSize=14';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>注意：</strong><code>document.cookie</code>一次只能写入一个 Cookie，而且写入并不是覆盖，而是添加。</p> <h4 id="js-cookie"><a href="#js-cookie" class="header-anchor">#</a> js-cookie</h4> <blockquote><p>https://github.com/js-cookie/js-cookie</p></blockquote> <h3 id="session"><a href="#session" class="header-anchor">#</a> Session</h3> <p>会话保持的机制，session 是记录客户状态的机制，不同的是 Cookie 保存在客户端浏览器中，而 session 保存在服务器上。</p> <h4 id="session-的使用"><a href="#session-的使用" class="header-anchor">#</a> session 的使用</h4> <ul><li><p>第三方模块 <a href="https://github.com/expressjs/session" target="_blank" rel="noopener noreferrer">express-session<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>配置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  secret<span class="token operator">:</span> <span class="token string">'keyboard cat'</span><span class="token punctuation">,</span> 
  cookie<span class="token operator">:</span> <span class="token punctuation">{</span> maxAge<span class="token operator">:</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>name: 设置 cookie 中，保存 session 的字段名称，默认为 connect.sid 。</li> <li>secret: 这个 string 对 sessionID 对应的cookie进行签名，并放在 cookie 中。</li> <li>cookie: 设置存放 session id 的 cookie 的相关选项，默认为 (default: { path: '/’, httpOnly: true, maxAge: null })</li> <li>resave: 强制session保存到session store中。即使在请求中这个session没有被修改。</li> <li>saveUninitialized: 强制没有“初始化”的session保存到storage中，没有初始化的session指的是：刚被创建没有被修改（第一次请求是否生成 sessionid）</li></ul></li> <li><p>使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// req.session 是一个对象</span>
<span class="token comment">// 当配置好 session 之后，可以使用 session 保持登录的状态</span>
req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>

<span class="token comment">// 在其他路由，可以判断登录的状态</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果状态不存在则没有登录</span>
<span class="token punctuation">}</span>

<span class="token comment">// 退出的时候要，销毁session</span>
req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul> <h4 id="session的原理"><a href="#session的原理" class="header-anchor">#</a> session的原理</h4> <ol><li>浏览器向服务器发送登录请求(post)，携带账号和密码</li> <li>登录成功，服务器记录登录的状态，req.session.user = user;  服务器记录这些信息</li> <li>服务器返回的响应头中携带 服务器生成的 sessionid(cookie中)，身份标示</li> <li>浏览器再次访问服务器的时候会通过cookie携带sessionid</li> <li>服务器获取浏览器发送的sessionid后，在服务器查找sessionid，如果找不到，未登录</li> <li>如果找到 sessionid，根据 sessionid 查找对应的对象，登录成功</li></ol> <h3 id="cookie-和-session-的区别"><a href="#cookie-和-session-的区别" class="header-anchor">#</a> Cookie 和 Session 的区别</h3> <ul><li>cookie 数据存放在客户端，session 数据放在服务器端。</li> <li>cookie 不是很安全，别人可以分析存放在本地的cookie 并进行 cookie 欺骗 考虑到安全应当使用session。</li> <li>session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能 考虑到减轻服务器性能方面，应当使用 cookie 。</li> <li>单个cookie保存的数据不能超过4K，很多浏览器都限制一个站点最多保存20个cookie。</li> <li>将登陆信息等重要信息存放为 session、其他信息如果需要保留，可以放在cookie中</li></ul> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <ul><li>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies</li></ul></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">6/15/2020, 8:57:45 AM</span></div></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/blog/assets/js/app.58f092a7.js" defer></script><script src="/blog/assets/js/3.02682d00.js" defer></script><script src="/blog/assets/js/1.871cdb80.js" defer></script><script src="/blog/assets/js/40.4c395ce2.js" defer></script>
  </body>
</html>
